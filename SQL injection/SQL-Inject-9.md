## 说明
- 作者 | Author：Time
- 时间 | Date：2018/10/17
- 来源 | Source：XDCMSV2.0.8-暗月视频

## 代码
- 分类 | Category：SQL inject
- 语言 | Language：PHP

```php
public function register_save(){
		$username=safe_html($_POST['username']);
		$password=$_POST['password'];
		$password2=$_POST['password2'];
		$fields=$_POST['fields'];//获取post传递过来的参数
		if(empty($username)||empty($password2)||empty($password)){
			showmsg(C('material_not_complete'),'-1');
		}
		if(!strlength($username,5)){
			showmsg(C('username').C('str_len_error').'5','-1');
		}
		if(!strlength($password,5)){
			showmsg(C('password').C('str_len_error').'5','-1');
		}
		if($password!=$password2){
			showmsg(C('password_different'),'-1');
		}
		$password=md5(md5($password));
		
		$user_num=$this->mysql->num_rows("select * from ".DB_PRE."member where `username`='$username'");//判断会员是否存在
		if($user_num>0){
			showmsg(C('member_exist'),'-1');
		}
		$ip=safe_replace(safe_html(getip()));
		$this->mysql->db_insert('member',"`username`='".$username."',`password`='".$password."',`creat_time`='".datetime()."',`last_ip`='".$ip."',`is_lock`='0',`logins`='0',`groupid`='1'");//插入主要字段——用户名、密码
		$last_id=$this->mysql->insert_id();
		
		//遍历，并且没有过滤fields参数
		$field_sql='';
		foreach($fields as $k=>$v){
			$f_value=$v;
			if(is_array($v)){
				$f_value=implode(',',$v);
			}
			$field_sql.=",`{$k}`='{$f_value}'";
		}
		$field_sql=substr($field_sql,1);//截取字符串
    	//拼接sql语句
		$field_sql="update ".DB_PRE."member set {$field_sql} where userid={$last_id}";
		$query=$this->mysql->query($field_sql);//直接带入数据库
		
		showmsg(C('register_success'),'index.php?m=member&f=register');
	}

//cms中过滤了GET方式的传输，没有过滤POST中的传递过来的参数
```

> 可以看见直接使用POST方式获取到fields，通过抓包可以直接看见post传递过来的参数携带这fields字段

![1539789289667](/home/time/.config/Typora/typora-user-images/1539789289667.png)

## 修复

过滤所有方式传递过来的数据。