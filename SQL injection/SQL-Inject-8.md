## 说明
- 作者 | Author：F4ke
- 时间 | Date：2018/09/24
- 来源 | Source：网鼎杯第四场--comment

## 代码
- 分类 | Category：SQL inject--二次注入
- 语言 | Language：PHP
```php
case 'write':
    $category = addslashes($_POST['category']);
    $title = addslashes($_POST['title']);
    $content = addslashes($_POST['content']);
    $sql = "insert into board
            set category = '$category',
                title = '$title',
                content = '$content'";
    $result = mysql_query($sql);
    header("Location: ./index.php");
    break;
case 'comment':
    $bo_id = addslashes($_POST['bo_id']);
    $sql = "select category from board where id='$bo_id'";
    $result = mysql_query($sql);
    $num = mysql_num_rows($result);
    if($num>0){
    $category = mysql_fetch_array($result)['category'];
    $content = addslashes($_POST['content']);
    $sql = "insert into comment
            set category = '$category',
                content = '$content',
                bo_id = '$bo_id'";
    $result = mysql_query($sql);
    }
    header("Location: ./comment.php?id=$bo_id");
    break;
```

## 分析
关键源码流程是登陆后发帖子，再发帖子的时候进行特殊字符过滤不存在注入，但是在评论帖子的时候，会把category这个参数的值读取重新插入到comment表中，此时存在二次注入漏洞可以利用
```sql
 $sql = "insert into comment set category = '$category',content = '$content',bo_id = '$bo_id'";
```
如果发帖子的时候category="', content=user(),/* "  ，评论的时候content=*/#。 此时sql请求变成
```sql
$sql = "insert into comment set category = '', content=user(),/*',content = '*/#',bo_id = '$bo_id'";
```
成功注入
==至于addslashes函数转义的问题，在存入数据库的时候/符号变没==

```mysql
mysql> insert into users
    -> (id, username, password)
    -> values
    -> (133, "kkkk\'","4789");
Query OK, 1 row affected (0.00 sec)

mysql> select * from users where id=133;
+-----+----------+----------+
| id  | username | password |
+-----+----------+----------+
| 133 | kkkk'    | 4789     |
+-----+----------+----------+
1 row in set (0.00 sec)
```

## 修复

> 建议在评论帖子的时候执行INSERT语句之前判断是否存在\，如果存在将所有参数重新过滤，杜绝二次注入。
> 使用正则匹配，不允许输入特殊字符，从而就修复这个漏洞。

---------------------

