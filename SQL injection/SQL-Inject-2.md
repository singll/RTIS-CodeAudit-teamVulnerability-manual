## 说明
- 作者 | Author：ama666
- 时间 | Date：2018/09/11
- 来源 | Source：红日年货Web新手入门专刊第一期

## 代码
- 分类 | Category：SQL inject
- 语言 | Language：PHP

```php
<?php
$usersf='';
$userid='';
if (!isset($_COOKIE["UserName"]) || !isset($_COOKIE["PassWord"])){
echo "<script>location.href='/user/login.php';</script>";
}else{
$username=nostr($_COOKIE["UserName"]);
	$rs=query("select id,usersf,lastlogintime from zzcms_user where lockuser=0 and username='".$username."' and password='".$_COOKIE["PassWord"]."'");
	$row=num_rows($rs);
		if (!$row){
		//if ($_COOKIE["UserName"]!=$_SESSION["UserName"] || $_COOKIE["PassWord"]!=$_SESSION["PassWord"]){//当记登录状态时，只有COOKIE，没有SESSION
		echo "<script>location.href='/user/login.php';</script>";
		}else{
		$row=fetch_array($rs);
		$usersf=$row['usersf'];//left.php中用
		$userid=$row['id'];//top中用
		$lastlogintime=$row['lastlogintime'];
		$password=$_COOKIE["PassWord"];
		query("UPDATE zzcms_user SET loginip = '".getip()."' WHERE username='".$username."'");//更新最后登录IP
		if (strtotime(date("Y-m-d H:i:s"))-strtotime($lastlogintime)>3600*24){
		query("UPDATE zzcms_user SET totleRMB = totleRMB+".jf_login." WHERE username='".$username."'");//登录时加积分
		query("insert into zzcms_pay (username,dowhat,RMB,mark,sendtime) values('".$username."','每天登录用户中心送积分','+".jf_login."','','".date('Y-m-d H:i:s')."')");
		}
		query("UPDATE zzcms_user SET lastlogintime = '".date('Y-m-d H:i:s')."' WHERE username='".$username."'");//更新最后登录时间
		}
}
?>
```
>代码片段中第二个查询语句中调用了getip()函数，并未经任何过滤仅仅是用引号闭合，猜测可能存在注入。

### 跟进getip()函数，再inc/function.php中

```php
function getip(){ 
if (getenv("HTTP_CLIENT_IP") && strcasecmp(getenv("HTTP_CLIENT_IP"), "unknown")) 
$ip = getenv("HTTP_CLIENT_IP"); 
else if (getenv("HTTP_X_FORWARDED_FOR") && strcasecmp(getenv("HTTP_X_FORWARDED_FOR"), "unknown")) 
$ip = getenv("HTTP_X_FORWARDED_FOR"); 
else if (getenv("REMOTE_ADDR") && strcasecmp(getenv("REMOTE_ADDR"), "unknown")) 
$ip = getenv("REMOTE_ADDR"); 
else if (isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], "unknown")) 
$ip = $_SERVER['REMOTE_ADDR']; 
else 
$ip = "unknown"; 
return($ip); 
} 
```
>看到getip()函数直接获取用户ip返回并未经过任何过滤，而ip可以通过修改X-Forward-For或者client-ip来进行控制，达到SQL注入的目的。


## 修复
​	建议对getip()函数的返回值进行消毒处理。