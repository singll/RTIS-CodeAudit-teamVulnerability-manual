## 说明
- 作者 | Author：x1a0t
- 时间 | Date：2018/09/11
- 来源 | Source：https://x1a0t.github.io/2018/07/24/OpenSNS5-8-0%20SQL%20Injection/

## 代码
- 分类 | Category：SQL inject
- 语言 | Language：PHP

此处为一处越权操作引发的SQL注入，以下代码来自opensns5.8.0，过程有部分省略

漏洞的产生是由于一处可越权操作函数代码，如下：

/Application/Weibo/Model/ShareModel.class.php:

```PHP
<?php
namespace Weibo\Model;

use Think\Model;

class ShareModel extends Model
{
    public function getInfo($param)
    {
        $info = array();
        if(!empty($param['app']) && !empty($param['model']) && !empty($param['method'])){
            $info = D($param['app'].'/'.$param['model'])->$param['method']($param['id']);
        }

        return $info;
    }

}
```

通过调用该函数的地方，我们可控制`$param`参数，使得我们可以控制Model下的部分函数，例如传入`$param['app']=Common`、`$param['model']=ActionLimitModel`调用到如下函数：

/Application/Common/Model/ActionLimitModel.class.php:29

```php
public function getActionLimit($where){
    $limit = $this->where($where)->find();
    return $limit;
}
```

正常调用该方法，不使用Thinkphp危险操作，是不会有SQL注入的。但是放到这里，我们直接传入`$where`，字符串也好，数组也好，Thinkphp中的SQL注入，怎么危险怎么来。例如传入`$param['id']=1%3d1 and updatexml(1,concat(0x7e,user()),1)`，开启debug模式即可看到报错



以下代码来自opensns5.8.0，



漏洞的产生是由于一处可以调用系统中一部分方法的代码，如下：

/Application/Weibo/Model/shareModel.class.php

```php
<?php
namespace Weibo\Model;

use Think\Model;

class ShareModel extends Model
{
    public function getInfo($param)
    {
        $info = array();
        if(!empty($param['app']) && !empty($param['model']) && !empty($param['method'])){
            $info = D($param['app'].'/'.$param['model'])->$param['method']($param['id']);
        }

        return $info;
    }

}
```

通过调用该漏洞函数，可控参数`$param`使得我们可以调用指定Model中的方法，限制条件是方法中的可控参数只有一个

选取一个可利用的方法，传入`$param['app']=Common`、`$param['model']=ActionLimitModel`如下：

/Application/Common/Model/ActionLimitModel.class.php:29

```php
public function getActionLimit($where){
    $limit = $this->where($where)->find();
    return $limit;
}
```

该方法正常情况下调用，Thinkphp使用得当，是不会有SQL注入的。但放到这里，我们直接传入`$where`参数，字符串也好，数组也好，使得我们可以随心所欲的注入，例如传入`$param['id']=1%3d1 and updatexml(1,concat(0x7e,user()),1)`开启debug模式即可看到报错信息了

## 修复

鉴于该处漏洞还可导致越权和SSRF，过滤恶意内容只能修复SQL，建议限制函数的调用范围