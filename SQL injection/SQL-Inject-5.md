## 说明
- 作者 | Author：ama666
- 时间 | Date：2018/09/12
- 来源 | Source：zzccms8.3

## 代码
- 分类 | Category：SQL inject
- 语言 | Language：PHP

```php
<?php
if ($tablename=='zzcms_guestbook'){
if (strpos($id,",")>0){	
	$sql="select id,saver from `".$tablename."` where id in (".$id.")";
}else{	
	$sql="select id,saver from `".$tablename."` where id ='$id'";
}
$rs=query($sql);
$row=num_rows($rs);
if ($row){
while ($row=fetch_array($rs)){	
	if ($row["saver"]<>$username){
	markit();
	showmsg('非法操作！警告：你的操作已被记录！小心封你的用户及IP！');
	}
	query("delete from `".$tablename."` where id =".$row['id']."");
}
echo "<script>location.href='".$pagename."';</script>";
}
?>
```
>问题代码位于user/del.php $tablename变量由POST提交，再文件开头引用了stopsqlin.php过滤文件，但是$tableanme变量并未使用引号包裹仅仅使用反引号，猜测过滤函数未能过滤反引号

### 跟进过滤文件，inc/stopsqlin.php
```php
<?php
function zc_check($string){
	if(!is_array($string)){
		if(get_magic_quotes_gpc()){
	 	return htmlspecialchars(trim($string));
		}else{
		return addslashes(htmlspecialchars(trim($string)));
		}
	 }
	foreach($string as $k => $v) $string[$k] = zc_check($v);
	return $string;
}
	
if($_REQUEST){
	$_POST =zc_check($_POST);
	$_GET =zc_check($_GET);
	$_COOKIE =zc_check($_COOKIE);
	@extract($_POST);
	@extract($_GET);	
}
?>
```
>截取关键部分代码，看到过滤函数zc_check()使用get_magic_quotes_gpc()对单/双引号，反斜线和NULL值进行转换，用htmlspcialchars()对单/双引号，大/小于号和&进行html实体编码，均未对反引号进行过滤，存在漏洞。


## 修复
​	在zc_check()中添加对反引号的过滤