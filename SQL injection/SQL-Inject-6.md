## 说明
- 作者 | Author：ama666
- 时间 | Date：2018/09/14
- 来源 | Source：http://www.freebuf.com/vuls/178316.html

## 代码
- 分类 | Category：SQL inject
- 语言 | Language：PHP

```php

public function operate(){
	$action = ForceStringFrom('dbaction');
	$tablename = ForceStringFrom('tablename');

	switch ($action){
		case 'checktable':
			$this->PrintResults('数据库表查错', $this->TableOperation($tablename, 'CHECK'));
			break;
		case 'checkall':
			$this->PrintResults('数据库表查错', $this->BatchTableOperation($_POST['tablenames'], 'CHECK'));
			break;

............(省略)

		case 'backupall':
			$this->PrintResults('数据库表备份', $this->BatchBackupTable($_POST['tablenames']));
			break;
		case 'emptytable':
			$this->PrintResults('数据库表清空', $this->EmptyTable($tablename));
			break;
	}	
}
?>
```

>截取关键部分代码，当action=emptytable时，调用敏感函数EmptyTable()。变量action由ForceStringFrom()函数获取，继续跟进此函数

```php
<?php
function ForceString($InValue, $DefaultValue = '') {
	if (is_string($InValue)) {
		$sReturn = EscapeSql(trim($InValue));
		if (empty($sReturn) && strlen($sReturn) == 0) $sReturn = $DefaultValue;
	} else {
		$sReturn = EscapeSql($DefaultValue);
	}
	return $sReturn;
}

// ##############################################################

function ForceStringFrom($VariableName, $DefaultValue = '') {
	if (isset($_GET[$VariableName])) {
		return ForceString($_GET[$VariableName], $DefaultValue);
	} elseif (isset($_POST[$VariableName])) {
		return ForceString($_POST[$VariableName], $DefaultValue);
	} else {
		return $DefaultValue;
	}
}
?>
```
>函数ForceStringFrom()调用函数ForceString()，后者使用EscapeSql()函数进行过滤，感觉到此就要找到关键的过滤函数了，跟进EscapeSql函数。

```php
<?php
function EscapeSql($query_string) {

	if (get_magic_quotes_gpc()) {
		$query_string = stripslashes($query_string);//去除反斜线
	}

	$query_string = htmlspecialchars(str_replace (array('\0', '　'), '', $query_string), ENT_QUOTES);
	//编码单、双引号
	
	if(function_exists('mysql_real_escape_string')) {
		$query_string = mysql_real_escape_string($query_string);
	}else if(function_exists('mysql_escape_string')){
		$query_string = mysql_escape_string($query_string);
	}else{
		$query_string = addslashes($query_string);
	}

	return $query_string;
}
?>
```

>该函数过滤了空格、\0，并对单、双引号进行了html实体编码，最后调用addslashes()函数过滤特殊字符，并未对反引号进行过滤。到此，SQL注入存在
```
payload:?dbaction=emptytable&tablename=hong_vvc%60%20where%20vvcid%3D1%20or%20updatexml%282%2Cconcat%280x7e%2C%28version%28%29%29%29%2C0%29%20or%20%60
```

## 修复

​1. 在EscapeSql()函数中对反引号进行过滤
2. 用引号包裹tablename变量