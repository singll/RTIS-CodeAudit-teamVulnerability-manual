## 说明
- 作者 | Author：Time
- 时间 | Date：2018/10/17
- 来源 | Source：PHPMPSV2.3

## 代码
- 分类 | Category：Cross Site Scripting
- 语言 | Language：PHP

此处是没有对修改发布信息进行过滤，产生的XSS漏洞，漏洞产生点：

/upload/member.php:

```PHP
case 'editinfo':
		$id = intval($_REQUEST['id']);
		$sql = "SELECT * FROM {$table}info WHERE id = '$id'";
		$info = $db->getRow($sql);
		if(empty($info)){showmsg('信息不存在','index.php');}
		checkInfoUser($id, trim($_REQUEST['password']));
		@extract($info);
		$postdate = date('Y年m月d日', $postdate);
		$lastdate = round(($enddate-time())/(3600*24));
		$lastdate = $lastdate ? $lastdate : '30';
		
		if(!empty($mappoint)) {
			$mappoints = explode(',', $mappoint);
		} elseif(!empty($CFG['map'])) {
			$mappoints = explode(',', $CFG['map']);
		}
		$custom = cat_post_custom($catid,$id);
		$info_area = area_options($areaid);

		$seo['title'] = '修改信息 - Powered by Phpmps';
		include template('edit_info');
	break;

	case 'updateinfo':
		$id       = intval($_POST['id']);
		checkInfoUser($id, trim($_REQUEST['password']));

		$title    = $_POST['title'] ? htmlspecialchars_deep(trim($_POST['title'])) : '';
		$areaid   = $_POST['areaid'] ? intval($_POST['areaid']) : '';
		$enddate  = !empty($_POST['enddate']) ? (intval($_POST['enddate']*3600*24)) + time() : '0';
		$content  = $_POST['content'] ? htmlspecialchars_deep(trim($_POST['content'])) : '';
		$linkman  = $_POST['linkman'] ? htmlspecialchars_deep(trim($_POST['linkman'])) : '';
		$phone    = $_POST['phone'] ? trim($_POST['phone']) : '';
		$qq       = $_POST['qq'] ? intval($_POST['qq']) : '';
		$email    = $_POST['email'] ? htmlspecialchars_deep(trim($_POST['email'])) : '';
		$address  = $_POST['address'] ? trim($_POST['address']) : '';//此处没有过滤xss
		$mappoint = $_POST['mappoint'] ? trim($_POST['mappoint']) : '';//此处没有过滤xss

		if(empty($title))showmsg("标题不能为空");
		if(empty($phone) && empty($qq) && empty($email))showmsg("电话、qq、email，必须填写一项");
		check_words(array($title,$content));

		//组成数组
		$items = array(
			'areaid' => $areaid,
			'title' => $title,
			'content' => $content,
			'linkman' => $linkman,
			'email' => $email,
			'qq' => $qq,
			'phone' => $phone,
			'mappoint' => $mappoint,
			'address' => $address,
			'enddate' => $enddate
		);
		$res = editInfo($items, $_POST['cus_value'], $id);//直接写入到了数据库
```

通过注册会员，并且发布一篇信息，在修改信息的时候插入xss代码，可直接执行，下面是调用editinfo函数

```php
function editInfo($items, $cusvalue, $id)
{
	global $db, $table;
	if(empty($items)) return '';
	$id = updatetable('info', $items, " id='$id'");
	
	//处理附加属性
	if (!empty($cusvalue)) {

		$cus_value_list = array();
		$res = $db->query("SELECT * FROM {$table}cus_value WHERE infoid = '$id'");
		while($row = $db->fetchRow($res)) {
			$cus_value_list[$row['cusid']][$row['cusvalue']] = array('query' => 'delete', 'id' => $row['id']);
		}

		foreach((array)$cusvalue AS $key => $val) {
			
			if(is_array($val)) $val=implode(",", $val);
			$cusvalue = $val;

			if(!empty($cusvalue)) {
				if (isset($cus_value_list[$key][$cusvalue])) {
					$cus_value_list[$key][$cusvalue]['query'] = 'update';
				} else {
					$cus_value_list[$key][$cusvalue]['query'] = 'insert';
				}
			}
		}

		foreach ((array)$cus_value_list as $cusid => $value_list) {
			foreach ((array)$value_list as $cusvalue => $infos) {
				if ($infos['query'] == 'insert') {
				   $sql = "INSERT INTO {$table}cus_value (cusid, infoid, cusvalue) VALUES ('$cusid', '$infoid', '$cusvalue')";
				} elseif ($infos['query'] == 'delete') {
					$sql = "DELETE FROM {$table}cus_value WHERE id = '$infos[id]' LIMIT 1";
				} elseif ($infos['query'] == 'update') {
					$sql = "UPDATE {$table}cus_value SET cusvalue='$cusvalue' WHERE id='$infos[id]' ";
				}
				$db->query($sql);
			}
		}
	}
	return true;
}
```

通过editinfo函数直接写入数据库，后台管理员查看发布信息也成功执行了xss代码。

## 修复

​	对所有参数做XSS过滤。